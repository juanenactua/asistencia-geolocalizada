<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Verificaci√≥n de asistencia</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; padding: 2em; }
  #msg { margin-top: 2em; font-size: 1.2em; }
</style>
</head>
<body>
<h2>Verificaci√≥n de asistencia</h2>
<p>Por favor, permite el acceso a tu ubicaci√≥n para registrar tu asistencia.</p>
<div id="msg">Verificando ubicaci√≥n...</div>

<script>
function getQueryParam(param) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(param);
}

const clase = getQueryParam("clase");
const latClase = parseFloat(getQueryParam("lat"));
const lonClase = parseFloat(getQueryParam("lon"));
const radio = parseFloat(getQueryParam("radio"));
const formUrl = decodeURIComponent(getQueryParam("form"));

function distanciaMetros(lat1, lon1, lat2, lon2) {
  const R = 6371e3; // metros
  const œÜ1 = lat1 * Math.PI / 180;
  const œÜ2 = lat2 * Math.PI / 180;
  const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
  const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(ŒîœÜ/2) ** 2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const latUser = pos.coords.latitude;
      const lonUser = pos.coords.longitude;
      const dist = distanciaMetros(latClase, lonClase, latUser, lonUser);
      if (dist <= radio) {
        document.getElementById("msg").innerText = 
          `Ubicaci√≥n validada (${dist.toFixed(1)} m). Redirigiendo...`;
        setTimeout(() => { window.location.href = formUrl; }, 1500);
      } else {
        document.getElementById("msg").innerHTML = 
          `üìç Est√°s a ${dist.toFixed(1)} m del aula. <br>
           Debes estar dentro de ${radio} m para registrar tu asistencia.`;
      }
    },
    (error) => {
      document.getElementById("msg").innerText = 
        "‚ùå No se pudo obtener la ubicaci√≥n. Activa el GPS y recarga la p√°gina.";
    }
  );
} else {
  document.getElementById("msg").innerText = 
    "‚ö†Ô∏è Tu navegador no soporta geolocalizaci√≥n.";
}
</script>
</body>
</html>

